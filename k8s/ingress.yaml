# ============================================================================
# UNIVERSAL DECISION PLATFORM - Ingress with Canary Traffic Splitting
# ============================================================================
# Uses NGINX Ingress Controller annotations for canary deployment
# Traffic split: 90% to v1 (stable), 10% to v2 (canary)
# ============================================================================

---
# Main Ingress - routes to v1 (stable)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: decision-platform-main
  namespace: decision-platform
  labels:
    app: decision-platform
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "30"
spec:
  rules:
    - host: decision.local  # Change for production
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: decision-platform-v1
                port:
                  number: 80

---
# Canary Ingress - routes 10% traffic to v2
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: decision-platform-canary
  namespace: decision-platform
  labels:
    app: decision-platform
  annotations:
    kubernetes.io/ingress.class: nginx
    # Canary configuration
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "10"  # 10% to v2
    # Optional: Route specific headers to canary
    nginx.ingress.kubernetes.io/canary-by-header: "X-Canary"
    nginx.ingress.kubernetes.io/canary-by-header-value: "true"
spec:
  rules:
    - host: decision.local  # Must match main ingress
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: decision-platform-v2
                port:
                  number: 80

---
# Optional: Separate endpoints for direct version access
# Useful for testing specific versions
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: decision-platform-direct
  namespace: decision-platform
  labels:
    app: decision-platform
  annotations:
    kubernetes.io/ingress.class: nginx
spec:
  rules:
    # Direct access to v1
    - host: decision-v1.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: decision-platform-v1
                port:
                  number: 80
    # Direct access to v2
    - host: decision-v2.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: decision-platform-v2
                port:
                  number: 80
